/* Script Purpose:
    This script creates views for the Gold layer in the data warehouse. 
*/

IF OBJECT_ID('gold.dim_customers', 'V') IS NOT NULL
    DROP VIEW gold.dim_customers;

CREATE VIEW gold.dim_customers as 
select 
			ROW_NUMBER() over (order by cst_id ) as customer_key ,              --surrogate_key 
			cst_id as customer_id,
			c.cst_key as customer_number,
			c.cst_firstname as first_name ,
			c.cst_lastname as last_name,
			a.bdate as birthdate  ,
			l.cntry  as country ,
			c.cst_marital_status as marital_status,
			case when c.cst_gndr != 'n/a' then cst_gndr
				else coalesce ( a.gen ,'n/a')
			end as gender 	 ,
			c.cst_create_date as create_date 
			
from silver.crm_cust_info c
		left join silver.erp_cust_az12 a
		on c.cst_key = a.cid
		left join silver.erp_loc_a101 l
		on c.cst_key = l.cid 
		;

IF OBJECT_ID('gold.dim_products', 'V') IS NOT NULL
    DROP VIEW gold.dim_products;

CREATE VIEW  gold.dim_products as 
SELECT
	ROW_NUMBER() over (order by p.prd_start_dt,p.prd_key) as product_key ,
	p.prd_id         as product_id,
    p.prd_key        as product_number,
	p.prd_nm         as product_name ,
    p.cat_id         as category_id,
	ca.cat           as category,
	ca.subcat        as subcategory,
	ca.maintenance   as maintenance,
    p.prd_cost       as product_cost,
    p.prd_line       as product_line,
    p.prd_start_dt   as start_date
  FROM silver.crm_prd_info p
  join silver.erp_px_cat_g1v2 ca
  on p.cat_id = ca.id 
  where prd_end_dt is null ; --filter data (no need historical data) ;


IF OBJECT_ID('gold.fact_sales', 'V') IS NOT NULL
    DROP VIEW gold.fact_sales;

create view gold.fact_sales as 

SELECT  
	  sl.sls_ord_num	as order_number ,
      c.customer_key	as customer_key,
	  pr.product_key	as product_key ,
      sl.sls_order_dt	as order_date,
      sl.sls_ship_dt	as shipping_date,
      sl.sls_due_dt		as due_date ,
      sl.sls_sales		as sales_amount ,
      sl.sls_quantity	as quantity ,
      sl.sls_price		as price 
	      
  FROM silver.crm_sales_details sl
  left join gold.dim_customers c
  on sl.sls_cust_id = c.customer_id
  left join gold.dim_products pr
  on sl.sls_prd_key =pr.product_number ;

